## 简单动态字符串(SDS)

`Redis`没有直接使用C语言传统得字符串表示(以空字符串结尾得字符数组),而是自己构建了一种名为简单动态字符串(`simple dynamic string, SDS`)的抽象类型,并将`SDS`用作`Redis`的默认字符串表示;

**`在Redis中,C语言的字符串只会作为字符串字面量用在一些无须对字符串值进行修改的地方;`**

### `SDS`的定义

每个`sds.h/sdshdr`结构表示一个`SDS`值:

```sdshdr
struct sdshdr{
	// 记录buf数组中已使用子节的数量
	// 等于SDS所保存字符串的长度
	int len;

	// 记录buf数组中未使用子节的数量
	int free;

	// 子节数组,用于保存字符串
	char buf[];
}sdshdr;
```

**`SDS`遵循C字符串以空字符结尾的惯例,保存空字符的1子节空间不计算在`SDS`的`len`属性里面,并且为空字符分配额外的1子节空间,以及添加空字符到字符串末尾等操作,都是由`SDS`函数自动完成的,所以这个空字符对于`SDS`的使用者来说是完全透明的;**

>遵循空字符结尾,`SDS`可以直接重用一部分C字符串函数库里面的函数;

### C字符串

C语言使用长度为`N+1`的字符数组来表示长度为`N`的字符串,并且字符数组的最后一个元素总是空字符`'\0'`;


### `Redis`自定义字符串结构优势

+ 常数复杂度获取字符串长度:
  + `SDS`在`len`属性中记录了`SDS`本身的长度,获取长度复杂度仅为`O(1)`
  + 设置和更新`SDS`长度的工作是由`SDS`的`API`在执行时自动完成的,无须进行任何手动修改长度的工作; 
+ 杜绝缓冲区溢出
  + 当`SDS API`需要对`SDS`进行修改时,`API`会先检查`SDS`空间是否满足修改所需的要求,如果不满足的话,`API`会自动将`SDS`的空间扩展至执行修改所需的大小,然后才执行实际的修改操作;
+ 减少修改字符串时带来的内存重分配次数
  + `SDS`通过**未使用空间**解除了字符串长度和底层数组长度之间的关联;
  + 在`SDS`中,`buf`数组的长度不一定就是字符数量加一,数组里面可以包含未使用的子节,而这些子节的数量就由`SDS`的`free`属性记录;
    + `空间预分配`,**用于优化`SDS`的字符串增长操作;**
      + `SDS`修改时,其长度小于`1MB`,分配和`len`属性同样大小的未使用空间;
      + `SDS`修改时,其长度大于等于`1MB`,分配`1MB`的未使用空间;
	+ `惰性空间释放`,**用于优化`SDS`的字符串缩短操作;**
	  + 当`SDS`的`API`需要缩短`SDS`保存的字符串时,程序并不立即使用内存重分配来回收缩短后多出来的子节,而是使用`free`属性将这些子节的数量记录起来,并等待将来使用;
+ 二进制安全
  + 由于C语言字符串的末尾是以空字符做为结尾,限制了C字符串只能保存文本数据,而不能保存像图片,音频,视频,压缩文件等二进制数据;
  + `SDS API`都会以处理二进制的方式来处理`SDS`存放在buf数组里的数据,不会对其中数据做任何限制,过滤或者假设;
    + `Redis`的`SDS`的`buf`属性,其保存一系列二进制数据;
+ 兼容部分C字符串函数


## 链表

对于`Redis`而言,链表也是自己构建实现的;

**每个链表节点使用一个`adlist.h/listNode`结构来表示:**

```listNode
typedef struct  listNode{
	// 前置节点
	struct listNode *prev;

	// 后置节点
	struct listNode *next;

	// 节点的值
	void *vlaue;
}listNode;
```

多个`listNode`可以通过`prev`和`next`指针组成双端链表;

使用`adlist.h/list`来持有链表的话.操作起来更加方便:

```list
typedef struct list {
	// 表头节点
    listNode *head;
    // 表尾节点
    listNode *tail;
    // 节点值复制函数
    void *(*dup)(void *ptr);
    // 节点值释放函数
    void (*free)(void *ptr);
    // 节点值对比函数
    int (*match)(void *ptr, void *key);
    // 链表所包含的节点数量
    unsigned long len;
} list;
```

`list`结构为链表提供了表头指针`head`,表尾指针`tail`,以及链表长度计数器`len`,而`dup`,`free`,`match`成员则是用于实现多态链表所需的类型特定函数;
+ `dup`函数用于复制链表节点所保存的值
+ `free`函数用于释放链表节点所保存的值
+ `match`函数用于对比链表节点所保存的值和另一个输入值是否相等


>`Redis`的链表实现的特性:
+ 双端 : 链表节点带有`prev`和`next`指针,获取某个节点的前置节点和后置节点的复杂度都是`O(1)`;
+ 无环 : 表头节点的`prev`指针和表尾节点的`next`指针都指向`NULL`,对链表的访问以`NULL`为终点;
+ 带表头指针和表尾指针 : 通过`list`结构的`head`指针和`tail`指针,程序获取链表的表头节点和表尾节点的复杂度为`O(1)`
+ 多态 : 链表节点使用`void*`指针来保存节点值,并且可以通过`list`结构的`dup`,`free`,`match`三个属性为节点值设置类型特定函数,所以链表可以用于保存各种不同类型的值;


## 字典

字典,又称为符号表(symbol table),关联数组(associative array)
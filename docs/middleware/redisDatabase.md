
## `服务器中的数据库`

`Redis`服务器将所有数据库都保存在服务器状态`redis.h/redisServer`结构的`db`数组中,`db`数组的每个项都是一个`redis.h/redisDb`结构,每个`redisDb`结构代表一个数据库.

**在初始化服务器时,程序会根据服务器状态的`dbnum`属性来决定应该创建多少个数据库,`dbnum`属性的值由服务器配置的`database`选项决定,默认情况下,该选项的值为`16`,所以`Redis`服务器默认会创建`16`个数据库.**

## `切换数据库`

每个`Redis`客户端都有自己的目标数据库,每当客户端执行数据库写命令或者数据库读命令的时候,目标数据库就会成为这些命令的操作对象.

默认情况下,`Redis`客户端的目标数据库为0号数据库,但客户端可以通过执行`SELECT`命令来切换目标数据库.
+ 在服务器内部,客户端状态`redisClient`结构的`db`属性记录了客户端当前的目标数据库,这个属性是一个指向`redisDb`结构的指针;
+ `redisClient.db`指针指向`redisServer.db`数组的其中一个元素,而被指向的元素就是客户端的目标数据库.
+ 通过修改`redisClient.db`指针,让它指向服务器中的不同数据库,从而实现切换目标数据库的功能;


## `数据库键空间`

`Redis`是一个键值对(`key-value pair`)数据库服务器,服务器中的每个数据库都由一个`redis.h/redisDb`结构表示,其中,`redisDb`结构的`dict`字典保存了数据库中的所有键值对,称这个字典为键空间(`key space`):
+ 键空间和用户所见的数据库是直接对应的:
  + 键空间的键也就是数据库的键,每个键都是一个字符串对象.
  + 键空间的值也就是数据库的值,每个值可以是字符串对象,列表对象,哈希表对象,集合对象和有序集合对象中的任意一种`Redis`对象.

因为数据库的键空间是一个字典,所以所有针对数据库的操作,比如添加一个键值对到数据库,或者从数据库中删除一个键值对,又或者在数据库中获取某个键值对等,实际上都是通过对键空间字典进行操作来实现的.


+ `添加新建`:添加一个新键值对到数据库,实际上就是将一个新键值对添加到键空间字典里面,其中键为字符串对象,而值则为任意一种类型的`Redis`对象.

+ `删除键`:就是在键空间里面删除键所对应的键值对对象.

+ `更新键`:就是对键空间里面键所对应的值对象进行更新,根据值对象的类型不同,更新的具体方法也会有所不同.

+ `对键取值`:就是在键空间中取出键所对应的值对象,根据值对象的类型不同,具体的取值方法也会有所不同.

+ `读写键空间时的维护操作`:当使用`Redis`命令对数据库进行读写时,服务器不仅会对键空间执行指定的读写操作,还会执行一些额外的维护操作;
  + 在读取一个键之后(读操作和写操作都要对键进行读取),服务器会根据键是否存在来更新服务器的键空间命中(hit)次数或键空间不命中(miss)次数;
  + 在读取一个键之后,服务器会更新键的`LRU`时间,这个值可以用于计算键的闲置时间.
  + 如果服务器在读取一个键时发现该键已经过期,那么服务器会先删除这个过期键,然后才执行余下的其他操作.
  + 如果有客户端使用`WATCH`命令监视了某个键,那么服务器在对被监视的键进行修改之后,会将这个键标记为脏(dirty),从而让事务程序注意到这个键已经被修改过.
  + 服务器每次修改一个键之后,都会对脏(dirty)键计数器的值增1,这个计数器会触发服务器的持久化以及复制操作.
  + 如果服务器开启了数据库通知功能,那么在对键进行修改之后,服务器将按配置发送相应的数据库通知.


## `设置键的生存时间或过期时间`

通过`EXPIRE`命令或者`PEXPIRE`命令,客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间(`Time To Live,TTL`),在经过指定的秒数或者毫秒数之后,服务器就会自动删除生存时间为`0`的键;

**`SETEX命令可以在设置一个字符串键的同时为键设置过期时间,因为这个命令是一个类型限定的命令(只能用于字符串键).`**


与`EXPIRE`命令和`PEXPIRE`命令类似,客户端可以通过`EXPIREAT`命令或`PEXPIREAT`命令,以秒或者毫秒精度给数据库中的某个键设置过期时间(`expire time`).
 + 过期时间是一个`UNIX`时间戳,当键的过期时间来临时,服务器就会自动从数据库中删除这个键;

`TTL`命令和`PTTL`命令接受一个带有生存时间或者过期时间的键,返回这个键的剩余生存时间,也就是,返回距离这个键被服务器自动删除还有多长时间;

>+ `Redis`有四个不同的命令可以用于设置键的生存时间(键可以存在多久)或过期时间(键什么时候会被删除):
  + `EXPIRE <key> <ttl>`命令:用于将键`key`的生存时间设置为`ttl`秒.
  + `PEXPIRE <key> <ttl>`命令:用于将键`key`的生存时间设置`ttl`毫秒.
  + `EXPIREAT <key> <timestamp>`命令:用于将键`key`的过期时间设置为`timestamp`所指定的秒数时间戳.
  + `PEXPIREAT <key> <timestamp>`命令:用于将键`key`的过期时间设置为`timestamp`所指定的毫秒数时间戳.

**虽然有多种不同单位和不同形式的设置命令,但是实际上都是使用`PEXPIREAT`命令来实现的:无论客户端执行的是以上四个命令中的那个,经过转换之后,最终的执行效果都和执行`PEXPIREAT`命令一样.**


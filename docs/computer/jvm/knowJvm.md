>Java源代码是怎么被机器识别并执行的呢?

是Java虚拟机,即`Java Virtual Machine`,简称`JVM`.JVM提供商包括`Sun`,`BEA`,`IBM`等.

>+ 1999年,Sun公司发布呢由`C/C++`实现的`HotSpot Java`虚拟机.
+ 2006年,在`JavaOne`大会上开源其关键核心技术,启动`OpenJDK`项目,逐步形成呢活跃的`OpenJDK`社区.
+ 2010年,`sun`公司被`Oracle`公司收购.`Oracle`的`HotSpot JVM`实现,是目前`OpenJDK`使用的主流`JVM`,**它采用解释与编译混合执行的模式,其JIT技术采用分层编译,极大地提升了Java的执行速度;**


### 字节码

Java所有的指令有200个左右,一个子节(8位)可以存储256种不同的指令信息,一个这样的子节称为字节码(Bytecode).

在代码的执行过程中,JVM将字节码解释执行,屏蔽对底层操作系统的依赖;JVM也可以将字节码编译执行,如果是热点代码,会通过JIT动态地编译位机器码,提高执行效率.

Java字节码文件起始4个子节非常特殊,开始`cafe babe`是Gosling定义的一个魔法数,意思是`Coffee Baby`,其十进制值为`340569158`.

它的作用是:标志该文件是一个Java类文件,如果没有识别该标志,说明文件不是Java类文件或者文件已受损,无法进行加载.而后两个子节为当前版本号;

纯数字的字节码阅读起来像天书,最初汇编语言为了改进机器语言,使用助记符来替代对应的数字指令.JVM在字节码上也设计了一套操作码助记符,使用特殊单词来标记这些数字;

>+ `ICONST_0`代表`00000011`,即十六进制数为`0x03`;
+ `ALOAD_0`代表`00101010`,即`0x2a`;
+ `POP`代表`01010111`,即`0x57`;
+ `ICONST`和`ALOAD`的首字母表示具体的数据类型,如`A`代表引用类型变量,`I`代表`int`类型相关,其他类型均是其类型的首字母;

>字节码主要指令如下
+ 加载或存储指令:在某个栈帧中,通过指令操作数据在虚拟机栈的局部变量表与操作栈之间来回传输:
  + 将局部变量加载到操作栈中.
  + 从操作栈顶存储到局部变量表.
  + 将常量加载到操作栈顶;如`ICONST`,`BIPUSH`,`SIPUSH`,`LDC`等;
+ 运算指令
+ 类型转换指令
+ 对象创建与访问指令
  + 创建对象指令.如`NEW`,`NEWARRAY`等
  + 访问属性指令.如`GETFIELD`,`PUTFIELD`,`GETSTATIC`等
  + 检查实例类型指令.如`INSTANCEOF`,`CHECKCAST`等
+ 操作栈管理指令
  + 出栈操作;
  + 复制栈顶元素并压入栈;
+ 方法调用与返回指令
  + `INVOKEVIRTUAL`指令,调用对象的实例方法;
  + `INVOKESPECIAL`指令,调用实例初始化方法,私有方法,父类方法等;
  + `INVOKESTATIC`指令,调用类静态方法;
  + `RETURN`指令,返回`VOID`类型;
+ 同步指令,JVM使用方法结构中的`ACC_SYNCHRONIZED`标志同步方法,指令集中有`MONITORENTER`,`MONITOREXIT`支持`synchronized`语义;

### 静态编译器如何将源码转化成字节码?

现实Java程序编写后是源代码文件,并不能交给机器直接执行,需要将其编译成为字节码甚至是机器码文件.

![classAnalysis.png](/images/classAnalysis.png)

>+ 词法解析:通过空格分隔出单词,操作符,控制符等信息,将其形成token信息流,传递给语法解析器;
+ 语法解析:把词法解析得到的token信息流按照Java语法规则组装成一颗语法树;
+ 语义分析:检查关键字的使用是否合理,类型是否匹配,作用域是否正确等;


字节码必须通过类加载过程加载到JVM环境后，才可以执行．

>执行有三种模式：
+ 解释执行
+ JIT编译执行；
+ JIT编译与解释混合执行(主流JVM默认执行模式)
  + 混合执行模式的又是在于解释器在启动时先解释执行,省去编译时间;
  + 随着时间推进,JVM通过热点代码统计分析,识别高频的方法调用,循环体,公共模块等;
  + 基于强大的JIT动态编译技术,将热点代码转换机器码,直接交给CPU执行;

**JIT,是将JAVA字节码动态地编译成可以直接发送给CPU处理器直接指令执行的机器码;**

![InstantaneousComplie](/images/InstantaneousComplie.png)

注意`解释执行`和`编译执行`在线上环境微妙的辨证关系.

机器在热机状态可以承受的负载要大于冷机状态(刚启动时).

如果以热机状态时的流量进行切流,可能使处于冷机状态的服务器因无法承载流量而假死.

在生产环境发布过程中,以分批的方式进行发布,根据机器数量划分成多个批次,每个批次的机器数至多占到整个集群的1/8;
多级缓存,是指在整个系统架构的不同系统层级进行数据缓存,以提升访问效率.

>一般系统整体流程如下:
1. 接入`Nginx`将请求负载均衡到应用`Nginx`,此处常用的负载均衡算法是轮询或者一致性哈希;
  + `轮询可以使服务器的请求更加均衡`;
  + `一致性哈希可以提升应用Nginx的缓存命中率`;
2. 应用`Nginx`读取本地缓存,如果本地缓存命中,则直接返回,使用应用`Nginx`本地缓存可以提升整体的吞吐量,降低后端压力,尤其应对热点问题非常有效;
  + 可以使用`Lua Shared Dict`/`Nginx Proxy Cache(磁盘/内存)`/`Local Redis实现`;
3. 如果`Nginx`本地缓存没命中,则会读取相应的分布式缓存;如果分布式缓存命中,则直接返回相应数据(并回写到`Nginx`本地缓存);
  + 如`Redis`缓存,还可以考虑使用主从架构来提升性能和吞吐量;
4. 如果分布式缓存也没有命中,则会回源到`Tomcat`集群,在回源到`Tomcat`集群时,也可以使用轮询和一致性哈希作为负载均衡算法;
5. 在`Tomcat`应用中,首先读取本地堆缓存.如果有,则直接返回(并会写到主`Redis`集群);
6. 作为可选部分,如果步骤4没有命中,则可以再尝试一次读主`Redis`集群操作,目的是防止当从集群有问题时的流量冲击;
7. 如果所有缓存都没有命中,则只能查询`DB`或相关服务获取相关数据并返回.
8. 步骤7返回的数据异步写到主`Redis`集群,此处可能有多个`Tomcat`实例同时写主`Redis`集群,会造成数据错乱.


**`整体分了三部分缓存:应用Nginx本地缓存,分布式缓存,Tomcat堆缓存;`**
+ `应用Nginx本地缓存` : 用来解决热点缓存问题
+ `分布式缓存` : 用来减少访问回源率
+ `Tomcat堆缓存` : 用于防止相关缓存失效/崩溃之后的冲击


## `如何缓存数据`

**对于缓存的数据,可以考虑不过期缓存和带过期时间缓存;什么场景应该选择哪种模式需要根据业务和数据量等因素来决定;**


+ `不过期缓存` 
  + 使用`Cache-Aside`模式,首先写数据库,如果成功,则写缓存.
    + 这种场景下存在事务成功/缓存写失败但无法回滚事务的情况.
  + 不要把写缓存放在事务中,尤其写分布式缓存,因为网络抖动可能导致写缓存响应时间很慢,引起数据库事务阻塞.
    + 如果对缓存数据一致性要求不是那么高,数据量也不是很大,则可以考虑定期全量同步缓存;
  + 对于长尾访问的数据/大多数数据访问频率都很高的场景,或者是缓存空间足够,都可以考虑不过期缓存;
    + 当缓存满了,可以考虑用`LRU`机制驱逐老的缓存数据;

+ `过期缓存`,如采用懒加载,一般用于缓存其他系统的数据/缓存空间有限/低频热点缓存等场景.
  + 首先读取缓存,如果不命中,则查询数据,然后异步写入缓存并设置过期时间,下次读取将命中缓存,如果不命中,则查询数据,然后异步写入缓存并设置过期时间,下次读取将命中缓存.



大流量事件来临前,研发人员需要对现有系统进行梳理,发现系统瓶颈和问题,然后进行鬼系统调优来提升系统的健壮性和处理能力.

一般通过系统压测来发现系统瓶颈和问题,然后进行系统优化和容灾(如系统参数调优,单机房容灾,多机房容灾等.)

即使已经把系统优化和容灾做得非常好了,但也存在一些不稳定因素,如网络,依赖服务得`SLA`不稳定等.


## `系统压测`

压测一般指性能压力测试,用来评估系统得稳定性和性能,通过压测数据进行系统容量评估,从而决定是否需要进行扩容或缩容;

+ `压测方案` : 
  + 压测接口
  + 并发量
  + 压测策略(突发,逐步加压,并发量)
+ `压测指标` : (机器负载,QPS/TPS,响应时间)
+ `压测报告`

### `线下压测`

通过如`JMeter`,`Apache ab`压测系统的某个接口或者某个组件,然后进行调优,实现单个接口或组件的性能最优.

**`由于环境不一样,仿真度不高,很难进行全链路压测,适合组件级的压测,数据只能作为参考;`**

### `线上压测`

+ `读压测` : 压测系统的读流量
+ `写压测` : 压测系统的写流量
  + 注意把压测写的数据和真实数据分离
  + 有时需要进行读写混合压测
+ `仿真压测` : 通过模拟请求进行系统压测,模拟请求的数据可以是使用程序构造,人工构造,或者使用`Nginx`访问日志,如果压测的数据量有限,则会形成请求热点;
+ `引流压测` : 使用`TCPCopy`复制线上真实流量,然后引流到压测集群进行压测,还可以将流量放大`N`倍,来观察服务器负载能力;
+ `隔离集群压测` : 将对外提供服务的部分服务器从线上集群摘除,然后将线上流量引流到该集群进行压测; 
+ `单机压测` : 对集群中的一台机器进行压测,从而评估出单机极限处理能力,发现单机的瓶颈点;

## `系统优化和容灾`

拿到压测报告后,接下来会分析报告,然后进行一些有针对性的优化,如硬件升级,系统扩容,参数调优,代码优化,架构优化(如加缓存,读写分离,历史数据归档)等;

## `应急预案`

在系统压测之后会发现一些系统瓶颈,在系统优化之后会提升系统吞吐量并降低响应时间,容灾之后的系统可用性得以保障,但还是会存在一些风险,如网络抖动,某台机器负载过高,某个服务变慢,数据库`Load`值过高等,为了防止因为这些问题而出现系统雪崩,需要针对这些情况制定应急预案,从而在出现突发情况时,有相应的措施来解决掉这些问题;

>应急预案:
+ `系统分级` : 可以按照交易核心系统和交易支撑系统进行划分;
+ `全链路分析` : 从用户入口到后端存储,梳理出各个关键路径,对相关路径进行评估并制定预案.
  + 关键路径包括:`网络接入层,应用接入层,Web应用层,服务层,数据层等`;
  + `网络接入层` : 由系统工程师负责,主要关注是机房不可用/`DNS`故障/`VIP`故障等预案处理;
  + `应用接入层` : 由开发工程师负责,主要关注点是上游应用路由切换,限流,降级,隔离等预案处理;
  + `Web应用层和服务层` : 由开发工程师负责,主要关注点是依赖服务的路由切换,连接池(数据库,线程池等)异常,限流,超时降级,服务异常降级,应用负载异常,数据库故障切换,缓存故障切换等;
  + `数据层` : 由开发工程师或系统工程师负责,主要关注点是数据库/缓存负载高,数据库/缓存故障等;